<html>
  <head>
    <title>数组网 - 彪悍的Demo无需解释</title>
    <link href="/css/site.css" rel="stylesheet">
    <script src="/js/less-3.8.0.min.js"></script>
    <link href="/css/github-markdown-2.10.0.css" rel="stylesheet">
    <script src="/js/markdown-0.5.0.js"></script>
  </head>
  <body>
    <div id="header">
      <div class="site-slogan">彪悍的Demo无须解释</div>
      <div><span class="site-name"><a href="/">数组网</a></span><span class="site-url"><a href="shuzu.org">shuzu.org</a></span></div>
    </div>
    <div id="main">
      <div id="repo-main">
        <div class="navigation"><span><a href="/">数组网</a></span><span> &gt; </span><span class="org-link"><a href="/orgs/kotlin-demos/index.html">kotlin-demos</a></span><span> &gt; </span><span class="repo-name">kotlin-code-generation</span><span class="repo-description"></span></div>
        <div id="readme">
          <div class="markdown markdown-body">Kotlin Code Generation
=====================

This project is just copied from &lt;https://github.com/JetBrains/kotlin-examples/tree/master/gradle/kotlin-code-generation&gt; with some modifications.

Directories and files:

- `annotation-processor`: definition of our custom `TestAnnotation`
- `example`: Use and test the `TestAnnotation`. See `example/build.gradle` for configuration of annotations

Run:

```
./gradlew clean test
```

You will see logs from `annotation-processor/src/main/java/TestAnnotationProcessor.kt` from the generated log file: `./kotlin.log`

Notice
------

AKPT is not supported by Kotlin-JS</div>
        </div>
        <div class="code-file panel markdown-body">
          <div class="header">
            <div class="name"><a href="https://github.com/kotlin-demos/kotlin-code-generation/blob/master/annotation-processor/build.gradle" target="_blank">build.gradle</a></div>
            <div class="path">annotation-processor/build.gradle</div>
          </div>
          <div class="body">
            <pre class="content"><code class="gradle">apply plugin: 'kotlin'

dependencies {
    compile &quot;org.jetbrains.kotlin:kotlin-stdlib:$kotlin_version&quot;
    compile 'com.github.yanex:takenoko:0.1'
}</code></pre>
          </div>
        </div>
        <div class="code-file panel markdown-body">
          <div class="header">
            <div class="name"><a href="https://github.com/kotlin-demos/kotlin-code-generation/blob/master/annotation-processor/src/main/kotlin/TestAnnotationProcessor.kt" target="_blank">TestAnnotationProcessor.kt</a></div>
            <div class="path">annotation-processor/src/main/kotlin/TestAnnotationProcessor.kt</div>
          </div>
          <div class="body">
            <pre class="content"><code class="kt">package org.kotlin.annotationProcessor

import org.yanex.takenoko.*
import java.io.File
import javax.annotation.processing.*
import javax.lang.model.SourceVersion
import javax.lang.model.element.Element
import javax.lang.model.element.TypeElement
import javax.tools.Diagnostic.Kind.*

@Target(AnnotationTarget.CLASS)
annotation class TestAnnotation

@SupportedSourceVersion(SourceVersion.RELEASE_8)
@SupportedAnnotationTypes(&quot;org.kotlin.annotationProcessor.TestAnnotation&quot;)
@SupportedOptions(TestAnnotationProcessor.KAPT_KOTLIN_GENERATED_OPTION_NAME)
class TestAnnotationProcessor : AbstractProcessor() {
    companion object {
        const val KAPT_KOTLIN_GENERATED_OPTION_NAME = &quot;kapt.kotlin.generated&quot;
    }

    fun log(line:String) {
        File(&quot;./kotlin.log&quot;).appendText(line + &quot;\n&quot;)
    }

    override fun process(annotations: MutableSet&lt;out TypeElement&gt;?, roundEnv: RoundEnvironment): Boolean {
        log(&quot;annotations: $annotations&quot;)
        log(&quot;roundEnv: $roundEnv&quot;)

        val annotatedElements = roundEnv.getElementsAnnotatedWith(TestAnnotation::class.java)
        log(&quot;annotatedElements: $annotatedElements&quot;)

        if (annotatedElements.isEmpty()) return false

        log(&quot;processingEnv: $processingEnv&quot;)
        log(&quot;processingEnv.options: &quot; + processingEnv.options)

        val kaptKotlinGeneratedDir = processingEnv.options[KAPT_KOTLIN_GENERATED_OPTION_NAME] ?: run {
            processingEnv.messager.printMessage(ERROR, &quot;Can't find the target directory for generated Kotlin files.&quot;)
            return false
        }

        log(&quot;kaptKotlinGeneratedDir: $kaptKotlinGeneratedDir&quot;)

        val generatedKtFile = kotlinFile(&quot;test.generated&quot;) {
            for (element in annotatedElements) {
                val typeElement = element.toTypeElementOrNull() ?: continue

                property(&quot;simpleClassName&quot;) {
                    receiverType(typeElement.qualifiedName.toString())
                    getterExpression(&quot;this::class.java.simpleName&quot;)
                }
            }
        }

        log(&quot;generatedKtFile: $generatedKtFile&quot;)

        File(kaptKotlinGeneratedDir, &quot;testGenerated.kt&quot;).apply {
            parentFile.mkdirs()
            writeText(generatedKtFile.accept(PrettyPrinter(PrettyPrinterConfiguration())))
        }

        return true
    }

    fun Element.toTypeElementOrNull(): TypeElement? {
        if (this !is TypeElement) {
            processingEnv.messager.printMessage(ERROR, &quot;Invalid element type, class expected&quot;, this)
            return null
        }

        return this
    }
}</code></pre>
          </div>
        </div>
        <div class="code-file panel markdown-body">
          <div class="header">
            <div class="name"><a href="https://github.com/kotlin-demos/kotlin-code-generation/blob/master/build.gradle" target="_blank">build.gradle</a></div>
            <div class="path">build.gradle</div>
          </div>
          <div class="body">
            <pre class="content"><code class="gradle">buildscript {
    ext.kotlin_version = '1.1.2-3'

    repositories {
        jcenter()
        mavenLocal()
    }
    dependencies {
        classpath &quot;org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version&quot;
    }
}

allprojects {
    repositories {
        jcenter()
        maven { url 'https://jitpack.io' }
    }
}
</code></pre>
          </div>
        </div>
        <div class="code-file panel markdown-body">
          <div class="header">
            <div class="name"><a href="https://github.com/kotlin-demos/kotlin-code-generation/blob/master/example/build.gradle" target="_blank">build.gradle</a></div>
            <div class="path">example/build.gradle</div>
          </div>
          <div class="body">
            <pre class="content"><code class="gradle">apply plugin: 'kotlin'
apply plugin: 'kotlin-kapt'

dependencies {
	compile &quot;org.jetbrains.kotlin:kotlin-stdlib:$kotlin_version&quot;

    compile project(&quot;:annotation-processor&quot;)
    kapt project(&quot;:annotation-processor&quot;)

    testCompile 'junit:junit:4.12'
}

apply plugin: 'idea'

idea {
    module {
        sourceDirs += files('build/generated/source/kapt/main', 'build/generated/source/kaptKotlin/main')
        generatedSourceDirs += files('build/generated/source/kapt/main', 'build/generated/source/kaptKotlin/main')
    }
}</code></pre>
          </div>
        </div>
        <div class="code-file panel markdown-body">
          <div class="header">
            <div class="name"><a href="https://github.com/kotlin-demos/kotlin-code-generation/blob/master/example/src/main/kotlin/Example.kt" target="_blank">Example.kt</a></div>
            <div class="path">example/src/main/kotlin/Example.kt</div>
          </div>
          <div class="body">
            <pre class="content"><code class="kt">package org.kotlin.test

import org.kotlin.annotationProcessor.TestAnnotation

@TestAnnotation
class SimpleClass

@TestAnnotation
class AnotherClass</code></pre>
          </div>
        </div>
        <div class="code-file panel markdown-body">
          <div class="header">
            <div class="name"><a href="https://github.com/kotlin-demos/kotlin-code-generation/blob/master/example/src/test/kotlin/test.kt" target="_blank">test.kt</a></div>
            <div class="path">example/src/test/kotlin/test.kt</div>
          </div>
          <div class="body">
            <pre class="content"><code class="kt">package org.kotlin.test

import org.junit.Test
import org.junit.Assert.*
import test.generated.simpleClassName

class AnnotationTest {
    @Test fun testSimple() {
        assertEquals(&quot;SimpleClass&quot;, SimpleClass().simpleClassName)
    }

    @Test fun testAnother() {
        assertEquals(&quot;AnotherClass&quot;, AnotherClass().simpleClassName)
    }
}</code></pre>
          </div>
        </div>
        <div class="code-file panel markdown-body">
          <div class="header">
            <div class="name"><a href="https://github.com/kotlin-demos/kotlin-code-generation/blob/master/example-js/build.gradle" target="_blank">build.gradle</a></div>
            <div class="path">example-js/build.gradle</div>
          </div>
          <div class="body">
            <pre class="content"><code class="gradle">apply plugin: 'kotlin2js'
apply plugin: 'kotlin-kapt'

dependencies {
    compile &quot;org.jetbrains.kotlin:kotlin-stdlib-js:$kotlin_version&quot;

    compile project(&quot;:annotation-processor&quot;)
    kapt project(&quot;:annotation-processor&quot;)

    testCompile &quot;org.jetbrains.kotlin:kotlin-test-js:$kotlin_version&quot;
}

apply plugin: 'idea'

idea {
    module {
        sourceDirs += files('build/generated/source/kapt/main', 'build/generated/source/kaptKotlin/main')
        generatedSourceDirs += files('build/generated/source/kapt/main', 'build/generated/source/kaptKotlin/main')
    }
}</code></pre>
          </div>
        </div>
        <div class="code-file panel markdown-body">
          <div class="header">
            <div class="name"><a href="https://github.com/kotlin-demos/kotlin-code-generation/blob/master/example-js/src/main/kotlin/ExampleJs.kt" target="_blank">ExampleJs.kt</a></div>
            <div class="path">example-js/src/main/kotlin/ExampleJs.kt</div>
          </div>
          <div class="body">
            <pre class="content"><code class="kt">package org.kotlin.test

import org.kotlin.annotationProcessor.TestAnnotation

@TestAnnotation
class SimpleJsClass

@TestAnnotation
class AnotherJsClass</code></pre>
          </div>
        </div>
        <div class="code-file panel markdown-body">
          <div class="header">
            <div class="name"><a href="https://github.com/kotlin-demos/kotlin-code-generation/blob/master/example-js/src/test/kotlin/test.kt" target="_blank">test.kt</a></div>
            <div class="path">example-js/src/test/kotlin/test.kt</div>
          </div>
          <div class="body">
            <pre class="content"><code class="kt">package org.kotlin.test

import org.junit.Test
import org.junit.Assert.*
import test.generated.simpleClassName

class AnnotationTest {
    @Test fun testSimple() {
        assertEquals(&quot;SimpleJsClass&quot;, SimpleJsClass().simpleClassName)
    }

    @Test fun testAnother() {
        assertEquals(&quot;AnotherJsClass&quot;, AnotherJsClass().simpleClassName)
    }
}</code></pre>
          </div>
        </div>
        <div class="code-file panel markdown-body">
          <div class="header">
            <div class="name"><a href="https://github.com/kotlin-demos/kotlin-code-generation/blob/master/settings.gradle" target="_blank">settings.gradle</a></div>
            <div class="path">settings.gradle</div>
          </div>
          <div class="body">
            <pre class="content"><code class="gradle">include ':annotation-processor', ':example', ':example-js'</code></pre>
          </div>
        </div>
        <div class="code-file panel markdown-body">
          <div class="header">
            <div class="name"><a href="https://github.com/kotlin-demos/kotlin-code-generation/blob/master/src/main/java/Library.java" target="_blank">Library.java</a></div>
            <div class="path">src/main/java/Library.java</div>
          </div>
          <div class="body">
            <pre class="content"><code class="java">/*
 * This Java source file was generated by the Gradle 'init' task.
 */
public class Library {
    public boolean someLibraryMethod() {
        return true;
    }
}
</code></pre>
          </div>
        </div>
        <div class="code-file panel markdown-body">
          <div class="header">
            <div class="name"><a href="https://github.com/kotlin-demos/kotlin-code-generation/blob/master/src/test/java/LibraryTest.java" target="_blank">LibraryTest.java</a></div>
            <div class="path">src/test/java/LibraryTest.java</div>
          </div>
          <div class="body">
            <pre class="content"><code class="java">/*
 * This Java source file was generated by the Gradle 'init' task.
 */
import org.junit.Test;
import static org.junit.Assert.*;

public class LibraryTest {
    @Test public void testSomeLibraryMethod() {
        Library classUnderTest = new Library();
        assertTrue(&quot;someLibraryMethod should return 'true'&quot;, classUnderTest.someLibraryMethod());
    }
}
</code></pre>
          </div>
        </div>
        <div class="github markdown-body"><span class="github-icon"><img src="/images/github.jpg"></span><span class="repo-url"><a href="https://github.com/kotlin-demos/kotlin-code-generation">打开Github项目地址</a></span><span class="repo-issues"><a href="https://github.com/kotlin-demos/kotlin-code-generation/issues?q=">有问题上Github Issues上讨论</a></span></div>
      </div>
    </div>
    <script src="/js/site.js"></script>
  </body>
</html>
