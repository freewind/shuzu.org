<html>
  <head>
    <title>数组网 - 彪悍的Demo无需解释</title>
    <link href="/css/site.css" rel="stylesheet">
    <script src="/js/less-3.8.0.min.js"></script>
    <link href="/css/github-markdown-2.10.0.css" rel="stylesheet">
    <script src="/js/markdown-0.5.0.js"></script>
  </head>
  <body>
    <div id="header">
      <div class="site-slogan">彪悍的Demo无须解释</div>
      <div><span class="site-name"><a href="/">数组网</a></span><span class="site-url"><a href="shuzu.org">shuzu.org</a></span></div>
    </div>
    <div id="main">
      <div id="repo-main">
        <div class="navigation"><span><a href="/">数组网</a></span><span> &gt; </span><span class="org-link"><a href="/orgs/db-demos/index.html">db-demos</a></span><span> &gt; </span><span class="repo-name">kotlin-h2-create-row-by-form-demo</span><span class="repo-description"></span></div>
        <div id="readme">
          <div class="markdown markdown-body">Kotlin H2 Create Row by Form Demo
=================================

Dynamically get column names from ResultSet and build a form.
When submitting the form, it will get all the values from the textfields and convert them to correct value(by the meta info get for the result set),
then run the generated sql to create new row into h2 database.


Run `Hello.kt` in your IDE.</div>
        </div>
        <div class="code-file panel markdown-body">
          <div class="header">
            <div class="name"><a href="https://github.com/db-demos/kotlin-h2-create-row-by-form-demo/blob/master/build.gradle" target="_blank">build.gradle</a></div>
            <div class="path">build.gradle</div>
          </div>
          <div class="body">
            <pre class="content"><code class="gradle">buildscript {
    ext.kotlin_version = '1.2.51'
    repositories {
        jcenter()
    }
    dependencies {
        classpath &quot;org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version&quot;
    }
}

apply plugin: 'kotlin'

compileKotlin {
    kotlinOptions.jvmTarget= &quot;1.8&quot;
}

repositories {
    jcenter()
}

dependencies {
    compile &quot;org.jetbrains.kotlin:kotlin-stdlib:$kotlin_version&quot;
    compile &quot;org.apache.commons:commons-lang3:3.7&quot;
    compile &quot;commons-io:commons-io:2.6&quot;
    compile 'no.tornado:tornadofx:1.7.16'
    compile 'freewind.github:lost-list-creator:0.3.0'
    compile 'com.h2database:h2:1.4.197'
    testCompile &quot;junit:junit:4.11&quot;
    testCompile 'org.assertj:assertj-core:3.9.0'
    testCompile &quot;org.jetbrains.kotlin:kotlin-test-junit:$kotlin_version&quot;
}

task wrapper(type: Wrapper) {
    gradleVersion = &quot;4.6&quot;
}
</code></pre>
          </div>
        </div>
        <div class="code-file panel markdown-body">
          <div class="header">
            <div class="name"><a href="https://github.com/db-demos/kotlin-h2-create-row-by-form-demo/blob/master/src/main/kotlin/example/Hello.kt" target="_blank">Hello.kt</a></div>
            <div class="path">src/main/kotlin/example/Hello.kt</div>
          </div>
          <div class="body">
            <pre class="content"><code class="kt">package example

import com.github.freewind.lostlist.ArrayLists
import javafx.beans.property.SimpleIntegerProperty
import javafx.beans.property.SimpleStringProperty
import javafx.collections.FXCollections.observableArrayList
import javafx.scene.control.TableView
import tornadofx.*
import java.sql.DriverManager
import java.sql.ResultSet
import java.sql.ResultSetMetaData
import java.sql.Types

val connection = run {
    Class.forName(&quot;org.h2.Driver&quot;)
    DriverManager.getConnection(&quot;jdbc:h2:mem:mydb&quot;, &quot;sa&quot;, &quot;sa&quot;)!!
}

data class User(private val id: Int, private val name: String) {
    val idProperty = SimpleIntegerProperty(id)
    val nameProperty = SimpleStringProperty(name)
}

private val data = observableArrayList&lt;User&gt;()

class HelloWorld : View() {

    private val columnMetas = getColumnMetaOfUserTable()

    private val user = mutableMapOf&lt;String, SimpleStringProperty&gt;().apply {
        columnMetas.forEach { meta -&gt;
            this[meta.columnName] = SimpleStringProperty()
        }
    }

    init {
        data.addAll(loadDbUsers())
    }

    private lateinit var tableView: TableView&lt;User&gt;

    override val root = hbox {
        tableview&lt;User&gt;(data) {
            tableView = this
            column(&quot;id&quot;, User::idProperty)
            column(&quot;name&quot;, User::nameProperty)
        }
        vbox {
            form {
                fieldset(&quot;New Row&quot;) {
                    columnMetas.forEach { meta -&gt;
                        field(meta.columnName) {
                            textfield(user[meta.columnName]!!)
                        }
                    }
                }
            }
            button(&quot;Add to database&quot;).setOnAction {
                createUser(user.mapValues { it.value.value })
            }
        }
    }

    private fun createUser(map: Map&lt;String, String&gt;) {
        val fields = columnMetas.map { it.columnName }.joinToString(&quot;, &quot;)

        val sql = &quot;&quot;&quot;insert into users($fields) values (${ArrayLists.createFilled(columnMetas.size, &quot;?&quot;).joinToString(&quot;,&quot;)})&quot;&quot;&quot;
        val stmt = connection.prepareStatement(sql)
        columnMetas.forEachIndexed { i, meta -&gt;
            val index = i + 1
            when (meta.type) {
                Types.VARCHAR -&gt; stmt.setString(index, map[meta.columnName])
                Types.INTEGER -&gt; stmt.setInt(index, map[meta.columnName]!!.toInt())
                else -&gt; println(&quot;Unhandled type: $meta&quot;)
            }
        }
        stmt.execute()

        data.clear()
        data.addAll(loadDbUsers())
    }

    private fun getColumnMetaOfUserTable(): List&lt;ColumnMeta&gt; {
        val rs = connection.createStatement().executeQuery(&quot;select * from users limit 0&quot;)
        return getColumnMeta(rs)
    }

    private fun loadDbUsers(): List&lt;User&gt; {
        val users = mutableListOf&lt;User&gt;()
        val rs = connection.createStatement().executeQuery(&quot;select * from users&quot;)
        while (rs.next()) {
            users.add(User(id = rs.getInt(&quot;id&quot;), name = rs.getString(&quot;name&quot;)))
        }
        return users
    }
}

class HelloWorldStyle : Stylesheet() {
    init {
        root {
            prefWidth = 600.px
            prefHeight = 400.px
        }
    }
}

class HelloWorldApp : App(HelloWorld::class, HelloWorldStyle::class)

// type: `java.sql.Types`
data class ColumnMeta(val columnName: String, val displayName: String, val type: Int, val required: Boolean)

private fun getColumnMeta(rs: ResultSet): List&lt;ColumnMeta&gt; {
    val metaData = rs.metaData
    return (1..metaData.columnCount).map { index -&gt;
        ColumnMeta(
                columnName = metaData.getColumnName(index),
                displayName = metaData.getColumnLabel(index),
                type = metaData.getColumnType(index),
                required = metaData.isNullable(index) == ResultSetMetaData.columnNoNulls
        )
    }.toList()
}

private fun prepareDbData() {
    connection.createStatement().use { stmt -&gt;
        with(stmt) {
            executeUpdate(&quot;create table users(id int primary key, name varchar(255))&quot;)
            executeUpdate(&quot;insert into users values(1, 'Hello')&quot;)
            executeUpdate(&quot;insert into users values(2, 'World')&quot;)
        }
    }
}

fun main(args: Array&lt;String&gt;) {
    prepareDbData()
    launch&lt;HelloWorldApp&gt;()
}</code></pre>
          </div>
        </div>
        <div class="github markdown-body"><span class="github-icon"><img src="/images/github.jpg"></span><span class="repo-url"><a href="https://github.com/db-demos/kotlin-h2-create-row-by-form-demo">打开Github项目地址</a></span><span class="repo-issues"><a href="https://github.com/db-demos/kotlin-h2-create-row-by-form-demo/issues?q=">有问题上Github Issues上讨论</a></span></div>
      </div>
    </div>
    <script src="/js/site.js"></script>
  </body>
</html>
