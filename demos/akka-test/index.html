<html>
<head>
    <title>akka-test - 数组网</title>
    <link rel="stylesheet" href="../../css/site.css">
    <link rel="stylesheet" href="../../css/github-markdown-2.10.0.css">
    <script src="../../js/showdown-1.8.6.min.js"></script>
</head>
<body>

<div id="demo-header">
    <div class="site-slogan">akka-test</div>
</div>


<div class="code-file center-in-page panel markdown-body">
    <div class="header">
        <div class="name">
            <a href="https://github.com/freewind-demos/akka-test/blob/master/src/main/scala/FailTest.scala" target="_blank" title="show github file">FailTest.scala</a>
        </div>
        <div class="path">src/main/scala/FailTest.scala</div>
    </div>
    <div class="body">
        <pre class="content"><code class="scala">import akka.actor.SupervisorStrategy.Restart
import akka.actor.{Actor, ActorSystem, OneForOneStrategy, Props, SupervisorStrategy}

object FailTest extends App {

  val system = ActorSystem(&quot;test-failure&quot;)

  val aaa = system.actorOf(Props(new AAA))

  aaa ! Start


}

class AAA extends Actor {

  val bbb = context.actorOf(Props(new BBB))

  override val supervisorStrategy: SupervisorStrategy = OneForOneStrategy(maxNrOfRetries = 10)({
    case _ =&gt; println(&quot;####### child has exception&quot;)
      Restart
  })

  override def receive: Receive = {
    case Start =&gt;
      bbb ! Hello
  }
}

class BBB extends Actor {
  println(&quot;####### BBB is created: &quot; + self.path.name)
  override def receive: Actor.Receive = {
    case Hello =&gt;
      println(&quot;####### receive Hello message&quot;)
      throw new Exception(&quot;Hello exception&quot;)
  }
}


case object Start
case object Hello
</code></pre>
    </div>
</div>
<div class="code-file center-in-page panel markdown-body">
    <div class="header">
        <div class="name">
            <a href="https://github.com/freewind-demos/akka-test/blob/master/src/main/scala/pass_functions/MyActor.scala" target="_blank" title="show github file">MyActor.scala</a>
        </div>
        <div class="path">src/main/scala/pass_functions/MyActor.scala</div>
    </div>
    <div class="body">
        <pre class="content"><code class="scala">package pass_functions

import akka.actor.{Props, ActorSystem, Actor}

object MyActorDemo extends App {

  def getVersionAndContent(): VersionAndContent = {
    new VersionAndContent(111, &quot;hello&quot;)
  }

  val context = ActorSystem(&quot;MyActorSystem&quot;)
  val actor = context.actorOf(Props[MyActor])
  actor ! ContentChange(&quot;/aaa&quot;, () =&gt; getVersionAndContent())
}
class MyActor extends Actor {
  override def receive: Receive = {
    case ContentChange(path: String, f) =&gt;
      println(&quot;### path: &quot; + path)
      println(&quot;### version and content: &quot; + f())
  }
}

case class VersionAndContent(version: Int, content: String)
case class ContentChange(path: String, f: () =&gt; VersionAndContent)
</code></pre>
    </div>
</div>
<div class="code-file center-in-page panel markdown-body">
    <div class="header">
        <div class="name">
            <a href="https://github.com/freewind-demos/akka-test/blob/master/src/main/scala/error_handling/ServerActorDemo.scala" target="_blank" title="show github file">ServerActorDemo.scala</a>
        </div>
        <div class="path">src/main/scala/error_handling/ServerActorDemo.scala</div>
    </div>
    <div class="body">
        <pre class="content"><code class="scala">package error_handling

import akka.actor.{Actor, ActorSystem, Props}

import scala.language.postfixOps

object ServerActorDemo extends App {
  val system = ActorSystem(&quot;demo&quot;)
  val actor = system.actorOf(Props[ServerActor])
  actor ! &quot;Start&quot;
  actor ! &quot;Start&quot;
  actor ! &quot;other&quot;

}


class ServerActor extends Actor {

  private var index = 0

  @throws[Exception](classOf[Exception])
  override def preRestart(reason: Throwable, message: Option[Any]): Unit = {
    super.preRestart(reason, message)
    println(&quot;### preRestart: &quot; + reason)
    sender() ! &quot;Server actor has something wrong&quot;
  }

  override def receive: Receive = {
    case &quot;Start&quot; =&gt;
      println(&quot;### actor started: &quot; + index)
      index += 1
      throw new Exception(&quot;My exception when starting&quot;)
    case msg =&gt;
      println(&quot;### actor get other message: &quot; + msg + &quot;, &quot; + index)
      throw new Exception(&quot;another exception for other messages: &quot; + msg)
  }
}
</code></pre>
    </div>
</div>
<div class="code-file center-in-page panel markdown-body">
    <div class="header">
        <div class="name">
            <a href="https://github.com/freewind-demos/akka-test/blob/master/src/main/scala/disconnect/MyLocalActor.scala" target="_blank" title="show github file">MyLocalActor.scala</a>
        </div>
        <div class="path">src/main/scala/disconnect/MyLocalActor.scala</div>
    </div>
    <div class="body">
        <pre class="content"><code class="scala">package disconnect

import akka.actor.{PoisonPill, Props, Actor, ActorSystem}
import com.typesafe.config.ConfigFactory
import akka.remote.{DisassociatedEvent, AssociatedEvent}

class MyLocalActor extends Actor {

  val selection = context.actorSelection(&quot;akka.tcp://EventStreamSystem@127.0.0.1:2050/user/RemoteEventStreamActor&quot;)

  override def preStart() {
    selection ! MyException
  }

  def receive = {
    case &quot;Exception&quot; =&gt; println(&quot;---------Exception-------------&quot;)

    case AssociatedEvent(localAddress, remoteAddress, inbound) =&gt;
      println(s&quot;### AssociatedEvent info : local address is $localAddress, remote address is $remoteAddress,&quot; +
        s&quot;inbound is $inbound&quot;)

    case DisassociatedEvent(localAddress, remoteAddress, inbound) =&gt;
      println(s&quot;### DisassociatedEvent info : local address is $localAddress, remote address is $remoteAddress,&quot; +
        s&quot;inbound is $inbound&quot;)

    case _ =&gt;
  }
}

object MyLocalConnector {
  def main(args: Array[String]) {
    val system = ActorSystem(&quot;LocalSystem&quot;,
      ConfigFactory.parseString(
        &quot;&quot;&quot;
          |akka {
          |  actor {
          |    provider = &quot;akka.remote.RemoteActorRefProvider&quot;
          |  }
          |  remote {
          |    enabled-transports = [&quot;akka.remote.netty.tcp&quot;]
          |  }
          |}
        &quot;&quot;&quot;.stripMargin)
    )
    val actor = system.actorOf(Props[MyLocalActor], &quot;MyLocalActor&quot;)

  }
}
</code></pre>
    </div>
</div>
<div class="code-file center-in-page panel markdown-body">
    <div class="header">
        <div class="name">
            <a href="https://github.com/freewind-demos/akka-test/blob/master/src/main/scala/disconnect/ExceptionMessage.scala" target="_blank" title="show github file">ExceptionMessage.scala</a>
        </div>
        <div class="path">src/main/scala/disconnect/ExceptionMessage.scala</div>
    </div>
    <div class="body">
        <pre class="content"><code class="scala">package disconnect

sealed trait ExceptionMessage extends Serializable

case class MyException(content : String) extends ExceptionMessage
</code></pre>
    </div>
</div>
<div class="code-file center-in-page panel markdown-body">
    <div class="header">
        <div class="name">
            <a href="https://github.com/freewind-demos/akka-test/blob/master/src/main/scala/disconnect/RemoteEventStream.scala" target="_blank" title="show github file">RemoteEventStream.scala</a>
        </div>
        <div class="path">src/main/scala/disconnect/RemoteEventStream.scala</div>
    </div>
    <div class="body">
        <pre class="content"><code class="scala">package disconnect

import akka.actor._
import akka.remote.{DisassociatedEvent, AssociatedEvent, RemotingLifecycleEvent}
import com.typesafe.config.ConfigFactory
import java.io.IOException

class RemoteEventStreamActor extends Actor{

  context.system.eventStream.subscribe(self, classOf[RemotingLifecycleEvent])

  def receive = {
    case AssociatedEvent(localAddress,remoteAddress,inbound) =&gt;
      println(s&quot;### AssociatedEvent info : local address is $localAddress, remote address is $remoteAddress,&quot; +
        s&quot;inbound is $inbound&quot;)

    case DisassociatedEvent(localAddress,remoteAddress,inbound) =&gt;
      println(s&quot;### DisassociatedEvent info : local address is $localAddress, remote address is $remoteAddress,&quot; +
        s&quot;inbound is $inbound&quot;)

    case MyException =&gt; {
//      throw new IOException(&quot;Exception occurs&quot;)
      sender ! &quot;Exception&quot;
      sender ! PoisonPill
      sender ! &quot;Exception&quot;
    }
  }
}

object RemoteEventStream {
  def main(args : Array[String]){
    val system = ActorSystem(&quot;EventStreamSystem&quot; ,
      ConfigFactory.parseString(
        &quot;&quot;&quot;
          |akka {
          |  actor {
          |    provider = &quot;akka.remote.RemoteActorRefProvider&quot;
          |  }
          |  remote {
          |    enabled-transports = [&quot;akka.remote.netty.tcp&quot;]
          |    netty.tcp {
          |      hostname = &quot;127.0.0.1&quot;
          |      port = 2050
          |    }
          | }
          |}
        &quot;&quot;&quot;.stripMargin)
    )
    val actor = system.actorOf(Props[RemoteEventStreamActor],&quot;RemoteEventStreamActor&quot;)
  }
}
</code></pre>
    </div>
</div>
<div class="code-file center-in-page panel markdown-body">
    <div class="header">
        <div class="name">
            <a href="https://github.com/freewind-demos/akka-test/blob/master/src/main/scala/sender_info/ServerActor.scala" target="_blank" title="show github file">ServerActor.scala</a>
        </div>
        <div class="path">src/main/scala/sender_info/ServerActor.scala</div>
    </div>
    <div class="body">
        <pre class="content"><code class="scala">package sender_info

import akka.actor._

object ActorDemo extends App {
  val system = ActorSystem(&quot;ServerActorDemo&quot;)
  val server = system.actorOf(Props[ServerActor])
  (0 to 10).map(i =&gt; system.actorOf(Props.create(classOf[ClientActor], server, i.toString))).foreach(_ ! &quot;Start&quot;)
}

class ServerActor extends Actor {
  override def receive: Receive = {
    case s: String if s.startsWith(&quot;OK&quot;) =&gt;
      println(&quot;message from client: &quot; + s)
      println(sender())
    case msg =&gt;
      println(&quot;message from client: &quot; + msg)
      println(sender())
      sender() ! &quot;OK&quot;
  }
}

class ClientActor(serverActor: ActorRef, index: String) extends Actor {
  override def receive: Actor.Receive = {
    case &quot;Start&quot; =&gt; serverActor ! &quot;Hello from client &quot; + index
    case &quot;OK&quot; =&gt; serverActor ! &quot;OK &quot; + index
  }
}
</code></pre>
    </div>
</div>
<div class="code-file center-in-page panel markdown-body">
    <div class="header">
        <div class="name">
            <a href="https://github.com/freewind-demos/akka-test/blob/master/src/main/scala/Main.scala" target="_blank" title="show github file">Main.scala</a>
        </div>
        <div class="path">src/main/scala/Main.scala</div>
    </div>
    <div class="body">
        <pre class="content"><code class="scala">import akka.actor.{ActorRef, Actor, Props, ActorSystem}
import akka.actor.Actor.Receive
import akka.routing.{RoundRobinPool, RoundRobinGroup, RoundRobinRouter}

object Pi extends App {
  private val number = 100000

  println((0 to number).sum)


  val system = ActorSystem(&quot;PiSystem&quot;)

  val listener = system.actorOf(Props(new Listener))
  val master = system.actorOf(Props(new Master(workerCount = 4, number = number, listener = listener)), &quot;master&quot;)

  master ! StartCalc
}

class Master(workerCount: Int, number: Int, listener: ActorRef) extends Actor {
  val worker = context.actorOf(Props(new Worker).withRouter(RoundRobinPool(workerCount)))
  val numbersList = (0 to number).grouped(10).toList

  override def receive: Receive = {
    next(0, 0)
  }

  def next(result: Int, messageCount: Int): Receive = {
    case StartCalc =&gt;
      println(&quot;Start!&quot;)
      numbersList.foreach(worker ! Work(_))
    case Result(sum) =&gt;
      (messageCount + 1, result + sum) match {
        case (newMessageCount, newResult) =&gt;
          context.become(next(newResult, newMessageCount))
          if (newMessageCount == numbersList.length) {
            listener ! FinalResult(newResult)
          }
      }

  }
}

class Listener extends Actor {
  override def receive: Actor.Receive = {
    case FinalResult(result) =&gt;
      println(&quot;####### total sum : &quot; + result)
      context.system.shutdown()
  }
}

class Worker extends Actor {
  override def receive: Actor.Receive = {
    case Work(nums) =&gt;
      sender ! Result(nums.sum)
  }
}

case object StartCalc
case class Work(nums: Seq[Int])
case class Result(sum: Int)
case class FinalResult(total: Int)
</code></pre>
    </div>
</div>

<div class="github center-in-page markdown-body">
    <span class="github-icon"><img src="../../images/github.jpg"></span>
    <span class="repo-url">
        <a href="https://github.com/freewind-demos/akka-test">打开Github项目地址</a>
    </span>
    <span class="repo-issues">
        <a href="https://github.com/freewind-demos/akka-test/issues?q=">有疑问上Github Issues上讨论</a>
    </span>
</div>

<script src="../../js/site.js"></script>
<script type="text/javascript">
    var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1274292847'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s13.cnzz.com/z_stat.php%3Fid%3D1274292847' type='text/javascript'%3E%3C/script%3E"));
</script>
</body>
</html>